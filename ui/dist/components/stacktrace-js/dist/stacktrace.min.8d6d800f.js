!function(global,factory){"object"==typeof exports?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.printStackTrace=factory()}(this,function(){function printStackTrace(options){var ex=(options=options||{guess:!0}).e||null,guess=!!options.guess,mode=options.mode||null,p=new printStackTrace.implementation,result=p.run(ex,mode);return guess?p.guessAnonymousFunctions(result):result}return printStackTrace.implementation=function(){},printStackTrace.implementation.prototype={run:function(ex,mode){return ex=ex||this.createException(),"other"===(mode=mode||this.mode(ex))?this.other(arguments.callee):this[mode](ex)},createException:function(){try{this.undef()}catch(e){return e}},mode:function(e){return"undefined"!=typeof window&&window.navigator.userAgent.indexOf("PhantomJS")>-1?"phantomjs":e.arguments&&e.stack?"chrome":e.stack&&e.sourceURL?"safari":e.stack&&e.number?"ie":e.stack&&e.fileName?"firefox":e.message&&e["opera#sourceloc"]?e.stacktrace?e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?"opera9":"opera10a":"opera9":e.message&&e.stack&&e.stacktrace?e.stacktrace.indexOf("called from line")<0?"opera10b":"opera11":e.stack&&!e.fileName?"chrome":"other"},instrumentFunction:function(context,functionName,callback){var original=(context=context||window)[functionName];context[functionName]=function(){return callback.call(this,printStackTrace().slice(4)),context[functionName]._instrumented.apply(this,arguments)},context[functionName]._instrumented=original},deinstrumentFunction:function(context,functionName){context[functionName].constructor===Function&&context[functionName]._instrumented&&context[functionName]._instrumented.constructor===Function&&(context[functionName]=context[functionName]._instrumented)},chrome:function(e){return(e.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(e){return e.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(e){return e.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(e){return e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(e){for(var lineRE=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/,lines=e.stacktrace.split("\n"),result=[],i=0,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){var location=match[4]+":"+match[1]+":"+match[2],fnName=match[3]||"global code";fnName=fnName.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}"),result.push(fnName+"@"+location+" -- "+lines[i+1].replace(/^\s+/,""))}}return result},opera10b:function(e){for(var lineRE=/^(.*)@(.+):(\d+)$/,lines=e.stacktrace.split("\n"),result=[],i=0,len=lines.length;i<len;i++){var match=lineRE.exec(lines[i]);if(match){var fnName=match[1]?match[1]+"()":"global code";result.push(fnName+"@"+match[2]+":"+match[3])}}return result},opera10a:function(e){for(var lineRE=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,lines=e.stacktrace.split("\n"),result=[],i=0,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){var fnName=match[3]||"{anonymous}";result.push(fnName+"()@"+match[2]+":"+match[1]+" -- "+lines[i+1].replace(/^\s+/,""))}}return result},opera9:function(e){for(var lineRE=/Line (\d+).*script (?:in )?(\S+)/i,lines=e.message.split("\n"),result=[],i=2,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);match&&result.push("{anonymous}()@"+match[2]+":"+match[1]+" -- "+lines[i+1].replace(/^\s+/,""))}return result},phantomjs:function(e){for(var lineRE=/(\S+) \((\S+)\)/i,lines=e.stack.split("\n"),result=[],i=1,len=lines.length;i<len;i++){lines[i]=lines[i].replace(/^\s+at\s+/gm,"");var match=lineRE.exec(lines[i]);match?result.push(match[1]+"()@"+match[2]):result.push("{anonymous}()@"+lines[i])}return result},other:function(curr){for(var fn,args,fnRE=/function(?:\s+([\w$]+))?\s*\(/,stack=[],slice=Array.prototype.slice;curr&&stack.length<10;){fn=fnRE.test(curr.toString())&&RegExp.$1||"{anonymous}";try{args=slice.call(curr.arguments||[])}catch(e){args=["Cannot access arguments: "+e]}stack[stack.length]=fn+"("+this.stringifyArguments(args)+")";try{curr=curr.caller}catch(e){stack[stack.length]="Cannot access caller: "+e;break}}return stack},stringifyArguments:function(args){for(var result=[],slice=Array.prototype.slice,i=0;i<args.length;++i){var arg=args[i];void 0===arg?result[i]="undefined":null===arg?result[i]="null":arg.constructor&&(arg.constructor===Array?arg.length<3?result[i]="["+this.stringifyArguments(arg)+"]":result[i]="["+this.stringifyArguments(slice.call(arg,0,1))+"..."+this.stringifyArguments(slice.call(arg,-1))+"]":arg.constructor===Object?result[i]="#object":arg.constructor===Function?result[i]="#function":arg.constructor===String?result[i]='"'+arg+'"':arg.constructor===Number?result[i]=arg:result[i]="?")}return result.join(",")},sourceCache:{},ajax:function(url){var req=this.createXMLHTTPObject();if(req)try{return req.open("GET",url,!1),req.send(null),req.responseText}catch(e){}return""},createXMLHTTPObject:function(){for(var xmlhttp,XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],i=0;i<XMLHttpFactories.length;i++)try{return xmlhttp=XMLHttpFactories[i](),this.createXMLHTTPObject=XMLHttpFactories[i],xmlhttp}catch(e){}},isSameDomain:function(url){return"undefined"!=typeof location&&-1!==url.indexOf(location.hostname)},getSource:function(url){return url in this.sourceCache||(this.sourceCache[url]=this.ajax(url).split("\n")),this.sourceCache[url]},guessAnonymousFunctions:function(stack){for(var i=0;i<stack.length;++i){var frame=stack[i],ref=/\{anonymous\}\(.*\)@(.*)/.exec(frame);if(ref){var m=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/.exec(ref[1]);if(m){var file=m[1],lineno=m[2],charno=m[3]||0;if(file&&this.isSameDomain(file)&&lineno){var functionName=this.guessAnonymousFunction(file,lineno,charno);stack[i]=frame.replace("{anonymous}",functionName)}}}}return stack},guessAnonymousFunction:function(url,lineNo,charNo){var ret;try{ret=this.findFunctionName(this.getSource(url),lineNo)}catch(e){ret="getSource failed with url: "+url+", exception: "+e.toString()}return ret},findFunctionName:function(source,lineNo){for(var line,m,commentPos,reFunctionDeclaration=/function\s+([^(]*?)\s*\(([^)]*)\)/,reFunctionExpression=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,reFunctionEvaluation=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,code="",maxLines=Math.min(lineNo,20),i=0;i<maxLines;++i)if((commentPos=(line=source[lineNo-i-1]).indexOf("//"))>=0&&(line=line.substr(0,commentPos)),line){if(code=line+code,(m=reFunctionExpression.exec(code))&&m[1])return m[1];if((m=reFunctionDeclaration.exec(code))&&m[1])return m[1];if((m=reFunctionEvaluation.exec(code))&&m[1])return m[1]}return"(?)"}},printStackTrace});